# Настройка роутеров для RouteRus VPN

## Обзор

Настройка WireGuard на роутере позволяет защитить весь домашний трафик автоматически. Все устройства в сети (компьютеры, телефоны, телевизоры, IoT) будут подключены к VPN без дополнительной настройки.

## Важные ограничения

⚠️ **Роутеры НЕ поддерживают обфускацию AmneziaWG!**

- Роутеры работают только со стандартным WireGuard протоколом
- Для критичных задач дополнительно используйте AmneziaVPN на отдельных устройствах
- Базовая маскировка возможна через нестандартные порты (443, 53, 993)

## Поддерживаемые роутеры

### ✅ Полностью поддерживаемые
- **Keenetic** (все модели с WireGuard)
- **OpenWrt** (версия 21.02+)
- **ASUS** (с прошивкой поддерживающей WireGuard)
- **MikroTik** (RouterOS 7.0+)

### ⚠️ Частично поддерживаемые
- **TP-Link** (только некоторые модели)
- **Netgear** (требует кастомная прошивка)

### ❌ Не поддерживаемые
- Большинство бюджетных роутеров без WireGuard

## Генерация конфигурации для роутера

### Автоматическая генерация

```bash
# В директории проекта RouteRus VPN
./scripts/router-config-generator.sh home-router keenetic

# Или через wg-manager
./scripts/wg-manager.sh create-client router home-router

# Или через Makefile
make generate-router
```

**Что получите:**
- `home-router.conf` - конфигурационный файл
- `home-router.json` - информация о ключах
- `home-router_setup.md` - инструкция по настройке

### Ручная генерация

1. Откройте веб-интерфейс RouteRus VPN: `http://your-server:51821`
2. Нажмите "Add Client"
3. Введите имя роутера (например, "home-router")
4. Скачайте конфигурацию
5. Удалите из файла параметры обфускации AmneziaWG

## Настройка по типам роутеров

## Keenetic

### Требования
- Прошивка 3.5+ с модулем WireGuard
- Активная подписка Keenetic Plus (для некоторых моделей)

### Пошаговая настройка

1. **Вход в веб-интерфейс**
   - Откройте `http://192.168.1.1` в браузере
   - Введите логин/пароль администратора

2. **Установка WireGuard** (если не установлен)
   - Перейдите в "Общие настройки" → "Обновления и компоненты"
   - Найдите "WireGuard VPN" и установите

3. **Создание VPN подключения**
   - Перейдите в "Интернет" → "Другие подключения"
   - Нажмите "Добавить подключение"
   - Выберите "WireGuard VPN"

4. **Настройка параметров**
   ```
   Описание: RouteRus VPN
   Приватный ключ: [из .conf файла]
   IP-адрес: [из .conf файла, например 10.8.0.2/32]
   DNS: 94.140.14.14, 94.140.15.15
   MTU: 1420

   Удалённый узел:
   Публичный ключ: [сервера из .conf]
   Endpoint: your-server.com:51820
   Разрешённые IP: 0.0.0.0/0
   ```

5. **Настройка маршрутизации**
   - В разделе "Интернет" → "Подключения"
   - Для WireGuard соединения включите "Использовать для выхода в интернет"
   - Приоритет установите выше основного подключения

6. **Применение настроек**
   - Нажмите "Сохранить"
   - Дождитесь установки соединения (зеленый индикатор)

### Дополнительные настройки Keenetic

```bash
# Обход российских сайтов (опционально)
# В "Интернет" → "Другие подключения" → "Политики доступа"
# Создайте правило для российских IP
```

## OpenWrt

### Требования
- OpenWrt 21.02 или новее
- Установленный пакет luci-proto-wireguard

### Установка WireGuard

```bash
# Подключение к роутеру по SSH
ssh root@192.168.1.1

# Обновление списка пакетов
opkg update

# Установка WireGuard
opkg install luci-proto-wireguard kmod-wireguard wireguard-tools
```

### Настройка через веб-интерфейс

1. **Вход в LuCI**
   - Откройте `http://192.168.1.1`
   - Войдите как root

2. **Создание интерфейса**
   - Network → Interfaces
   - Add new interface...
   - Name: `wg0`
   - Protocol: `WireGuard VPN`

3. **Настройка интерфейса**
   ```
   Private Key: [из .conf файла]
   IP Addresses: [например, 10.8.0.2/32]
   ```

4. **Добавление peer**
   - В разделе Peers нажмите "Add peer"
   ```
   Public Key: [сервера]
   Allowed IPs: 0.0.0.0/0
   Endpoint Host: your-server.com
   Endpoint Port: 51820
   Persistent Keep Alive: 25
   ```

5. **Настройка firewall**
   - Назначьте интерфейс зоне `wan`
   - Разрешите форвардинг

### Настройка через командную строку

```bash
# Создание конфигурации
cat > /etc/config/network << EOF
config interface 'wg0'
    option proto 'wireguard'
    option private_key 'YOUR_PRIVATE_KEY'
    list addresses '10.8.0.2/32'

config wireguard_wg0
    option public_key 'SERVER_PUBLIC_KEY'
    option endpoint_host 'your-server.com'
    option endpoint_port '51820'
    list allowed_ips '0.0.0.0/0'
    option persistent_keepalive '25'
EOF

# Применение настроек
/etc/init.d/network reload
```

## ASUS

### Поддерживаемые модели
- RT-AX86U, RT-AX88U
- RT-AC86U, RT-AC88U
- И другие с поддержкой WireGuard

### Настройка

1. **Обновление прошивки**
   - Убедитесь что установлена последняя прошивка с WireGuard

2. **Включение WireGuard**
   - VPN → WireGuard
   - Enable WireGuard: Yes

3. **Добавление клиента**
   - Import client configuration
   - Вставьте содержимое .conf файла
   - Или настройте вручную:
   ```
   Client Name: RouteRus
   Private Key: [из .conf]
   Public Key: [сервера]
   Endpoint: your-server.com:51820
   Allowed IPs: 0.0.0.0/0
   ```

4. **Настройка DNS**
   - Adaptive QoS → DNS Filter
   - Global Filter Mode: Router
   - DNS Server 1: 94.140.14.14
   - DNS Server 2: 94.140.15.15

## MikroTik

### Требования
- RouterOS 7.0 или новее
- WireGuard пакет (обычно предустановлен)

### Настройка через WinBox

1. **Создание интерфейса WireGuard**
   - Interfaces → WireGuard → Add New
   ```
   Name: wg0
   Private Key: [сгенерировать или вставить]
   ```

2. **Добавление IP адреса**
   - IP → Addresses → Add New
   ```
   Address: 10.8.0.2/32
   Interface: wg0
   ```

3. **Настройка peer**
   - Interfaces → WireGuard → Peers → Add New
   ```
   Interface: wg0
   Public Key: [сервера]
   Endpoint: your-server.com:51820
   Allowed Address: 0.0.0.0/0
   ```

4. **Настройка маршрутизации**
   - IP → Routes → Add New
   ```
   Dst. Address: 0.0.0.0/0
   Gateway: wg0
   Distance: 1
   ```

### Настройка через CLI

```bash
# Создание интерфейса
/interface wireguard add name=wg0 private-key="YOUR_PRIVATE_KEY"

# Добавление IP
/ip address add address=10.8.0.2/32 interface=wg0

# Добавление peer
/interface wireguard peers add interface=wg0 \
public-key="SERVER_PUBLIC_KEY" \
endpoint-address=your-server.com \
endpoint-port=51820 \
allowed-address=0.0.0.0/0

# Маршрут по умолчанию
/ip route add dst-address=0.0.0.0/0 gateway=wg0

# DNS
/ip dns set servers=94.140.14.14,94.140.15.15
```

## Рекомендации по настройке

### Оптимальные параметры

```ini
# Для всех роутеров
MTU = 1420              # Стабильность соединения
PersistentKeepalive = 0 # Экономия трафика (для роутеров не критично)

# DNS серверы
DNS = 94.140.14.14,94.140.15.15  # AdGuard публичные
```

### Безопасность

1. **Смена портов**
   - Используйте порт 443 вместо 51820 для лучшей маскировки
   - На сервере настройте перенаправление портов

2. **Backup конфигурации**
   - Сохраните настройки роутера
   - Запишите ключи WireGuard

3. **Мониторинг**
   - Регулярно проверяйте статус соединения
   - Мониторьте трафик и скорость

### Производительность

1. **Оптимизация CPU**
   - На слабых роутерах отключите ненужные сервисы
   - Используйте аппаратное ускорение если доступно

2. **Настройка QoS**
   - Приоритизируйте VPN трафик
   - Ограничьте торренты и потоковое видео

## Проверка работы

### Базовая проверка

1. **Статус подключения**
   - Проверьте что WireGuard интерфейс активен
   - Убедитесь что есть handshake с сервером

2. **Проверка IP адреса**
   ```bash
   # На любом устройстве в сети
   curl ifconfig.me
   # Должен показывать IP сервера VPN
   ```

3. **Проверка DNS**
   ```bash
   nslookup doubleclick.net
   # Должен возвращать заблокированный IP (AdGuard)
   ```

### Расширенная диагностика

```bash
# На роутере (где возможно)
# Keenetic
show interface
show wireguard

# OpenWrt
wg show
ip route show

# MikroTik
/interface wireguard print
/interface wireguard peers print
```

## Устранение проблем

### Роутер не подключается

1. **Проверьте порты**
   - Убедитесь что порт 51820 открыт на сервере
   - Попробуйте порт 443

2. **Проверьте ключи**
   - Убедитесь что публичный ключ роутера добавлен на сервер
   - Проверьте правильность приватного ключа

3. **MTU проблемы**
   - Попробуйте MTU 1280
   - Постепенно увеличивайте до 1420

### Медленная скорость

1. **CPU роутера**
   - WireGuard может загружать слабые процессоры
   - Рассмотрите более мощный роутер

2. **Настройки сервера**
   - Проверьте загрузку VPN сервера
   - Рассмотрите сервер ближе к вашему местоположению

### Некоторые сайты не работают

1. **Split tunneling**
   - Настройте обход российских сайтов
   - Используйте селективную маршрутизацию

2. **DNS проблемы**
   - Попробуйте другие DNS серверы
   - Отключите DNS over HTTPS в браузере

## Дополнительные возможности

### Селективная маршрутизация

Для направления только части трафика через VPN:

```bash
# Только зарубежные сайты через VPN
# Список IP адресов для обхода

# Keenetic: используйте "Политики доступа"
# OpenWrt: настройте route-map
# MikroTik: используйте routing rules
```

### Мультисерверная настройка

```bash
# Несколько VPN серверов для отказоустойчивости
# Автоматическое переключение при сбоях
```

## Следующие шаги

После настройки роутера:

1. Протестируйте все устройства в сети
2. Настройте дополнительные устройства с AmneziaVPN для критичных задач
3. Изучите [SECURITY.md](SECURITY.md) для повышения безопасности
4. При проблемах см. [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
